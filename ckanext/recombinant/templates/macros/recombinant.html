{% macro dictionary_header(chromo, h) %}
  <h3>{{ _("Data Dictionary") }}</h3>
  <div class="form-group control-medium row">
    <div class="col-md-6">
      <a class="button" href="{{ h.url_for(
        'recombinant.data_dictionary',
        dataset_type=chromo.dataset_type) }}"><span class="glyphicon glyphicon-download-alt"></span>
        {{ _('Download data dictionary') }} XLSX</a>
    </div>
    <div class="col-md-6">
      <a class="button" href="{{ h.url_for(
        'recombinant.schema_json',
        dataset_type=chromo.dataset_type) }}"><span class="glyphicon glyphicon-wrench"></span>
        {{ _('Schema as JSON') }}</a>
    </div>
  </div>
{% endmacro %}

{% macro dictionary_field(label) %}
  {% set content = caller().strip() %}
  {% if content %}
    <dt class="col-md-3 text-secondary">{{ label }}</dt>
    <dd class="col-md-9">{{ content }}</dd>
  {% endif %}
{% endmacro %}

{% macro dictionary_field_html(field, chromo, choice_fields, loop, h, all_expanded) %}
  {% if field.get('visible_to_public', true) %}
    {% set field_type %}{{
      field.datastore_type[1:] ~ '[]' if field.datastore_type[0] == '_'
      else field.datastore_type }}{% endset %}

    {% set extra_info -%}
      {% call dictionary_field(_('Label')) %}
        {{ h.recombinant_language_text(field.label) }}
      {% endcall %}
      {% call dictionary_field(_('Description')) %}
        {{ h.render_markdown(h.recombinant_language_text(field.description)) |
          replace('\n', '<br>' | safe) }}
      {% endcall %}
      {% call dictionary_field(_('Obligation')) %}
        {{ _('Primary key') if field.datastore_id in chromo.datastore_primary_key
        else _('Required') if field.excel_required
        else field.get(h.lang()) if field.get('obligation') is mapping else _(field.get('obligation', '')) }}
      {% endcall %}
      {% call dictionary_field(_('Occurrence')) %}
        {{ h.recombinant_language_text(field.occurrence) }}
      {% endcall %}
      {% set choices = choice_fields.get(field.datastore_id) %}
      {% if choices %}
        {% call dictionary_field(_('Choices')) %}
          <table class="table table-striped table-bordered table-condensed" data-module-show-label="{{ _('Show more') }}" data-module-hide-label="{{ _('Hide') }}" data-module="table-toggle-more">
            <thead>
              <tr>
                <th scope="col">{{ _('Code') }}</th>
                <th scope="col">{{ _('Description') }}</th>
              </tr>
            </thead>
            {% set _choices = choices %}
            {% set _more_choices = [] %}
            {% if choices|length > 30 %}
              {% set _choices = choices[:30] %}
              {% set _more_choices = choices[30:] %}
            {% endif %}
            <tbody>
              {% for code, desc in _choices %}
                <tr>
                  <td>{{ code }}</td>
                  <td>{{ desc }}</td>
                </tr>
              {% endfor %}
              {% if _more_choices %}
                {% for code, desc in _more_choices %}
                  <tr class="toggle-more">
                    <td>{{ code }}</td>
                    <td>{{ desc }}</td>
                  </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        {% endcall %}
      {% endif %}

    {%- endset %}
    {# render_markdown to strip snippet comments and whitespace #}
    {% set has_extra=not all_expanded and h.render_markdown(extra_info) %}

    <div class="panel{% if has_extra %} panel-default{% endif %}">
      <div class="panel-heading">
        <div class="row panel-title{% if has_extra %} collapsed{% endif %}"
        {% if has_extra %}
          role="button" data-toggle="collapse" aria-expanded="false"
          href="#collapse{{ prefix }}-{{ loop.index }}"
        {% endif %}>
          <div class="col-md-1">{{ loop.index }}.</div>
          <div class="col-md-6">{{
          h.recombinant_language_text(field.label)
          or field.datastore_id
          }}</div>
          <div class="col-md-4">{{ field_type }}</div>
          <div class="col-md-1">{% if has_extra  %}»{% endif %}</div>
        </div>
      </div>
      {% if has_extra or all_expanded %}
        <div id="collapse{{ prefix }}-{{ loop.index }}" role="tabpanel"
          class="panel-collapse {% if not all_expanded %}collapse{% endif %}"
          aria-labelledby="field-{{ loop.index }}">
          <div class="panel-body">
            <dl class="row">
              {% call dictionary_field(_('ID')) %}{{ field.datastore_id }}{% endcall %}
              {% call dictionary_field(_('Type')) %}{{ field_type }}{% endcall %}
              {{ extra_info }}
            </dl>
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endmacro %}

{% macro vanilla_dictionary_field_html(field, loop, h) %}
  {% set field_type %}{{ field.type }}{% endset %}

  {% set extra_info -%}
    {% call dictionary_field(_('Label')) %}
      {{ h.get_translated(field.get('info', {}), 'label') }}
    {% endcall %}
    {% call dictionary_field(_('Description')) %}
      {{ h.render_markdown(h.get_translated(
        field.get('info', {}), 'notes')) }}
    {% endcall %}
    {% call dictionary_field(_('Label')) %}
      {{ field.get('info', {}).get('label_' ~ h.lang(), '') }}
    {% endcall %}
    {% call dictionary_field(_('Description')) %}
      {{ field.get('info', {}).get('notes_' ~ h.lang(), '') }}
    {% endcall %}
  {%- endset %}
  {# render_markdown to strip snippet comments and whitespace #}
  {% set has_extra=h.render_markdown(extra_info) %}

  <div class="panel{% if has_extra %} panel-default{% endif %}">
    <div class="panel-heading">
      <div class="row panel-title{% if has_extra %} collapsed{% endif %}"
      {% if has_extra %}
        role="button" data-toggle="collapse" aria-expanded="false"
        href="#collapse{{ prefix }}-{{ loop.index }}"
      {% endif %}>
        <div class="col-md-1">{{ loop.index }}.</div>
        <div class="col-md-6">{{
        h.get_translated(field.get('info', {}), 'label') or field.get('info', {}).get('label_' ~ h.lang(), '') or field.id
        }}</div>
        <div class="col-md-4">{{ field_type }}</div>
        <div class="col-md-1">{% if has_extra  %}»{% endif %}</div>
      </div>
    </div>
    {% if has_extra %}
      <div id="collapse{{ prefix }}-{{ loop.index }}" role="tabpanel"
        class="panel-collapse collapse"
        aria-labelledby="field-{{ loop.index }}">
        <div class="panel-body">
          <dl class="row">
            {% call dictionary_field(_('ID')) %}{{ field.id }}{% endcall %}
            {% call dictionary_field(_('Type')) %}{{ field_type }}{% endcall %}
            {{ extra_info }}
          </dl>
        </div>
      </div>
    {% endif %}
  </div>
{% endmacro %}
